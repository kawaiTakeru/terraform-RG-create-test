trigger:
- main

pool:
  name: Default
  demands:
    - agent.name -equals LAPTOP-OEOER8OI

jobs:
- job: terraform_apply
  displayName: 'Terraform Apply Job'
  steps:
  - checkout: self

  - task: PowerShell@2
    displayName: 'Step 1: Terraform Init'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "📋 Terraform Init 開始"
        terraform init

  - task: PowerShell@2
    displayName: 'Step 2: Terraform Plan'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "📋 Terraform Plan 開始"
        terraform plan

  - task: PowerShell@2
    displayName: 'Step 3: Terraform Apply'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "📋 Terraform Apply 開始"
        terraform apply -auto-approve

  # 成功時のSlack通知
  - task: PowerShell@2
    displayName: 'Notify Slack (Success)'
    condition: succeeded()
    inputs:
      targetType: 'inline'
      script: |
        $webhookUrl = 'https://hooks.slack.com/services/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'
        $payload = @{
          text = "✅ Terraform Apply 完了: `rg-terraform-test-01` が作成されました 🎉"
        } | ConvertTo-Json -Depth 3
        try {
          Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
        } catch {
          Write-Host "Slack通知に失敗しました（成功通知）: $($_.Exception.Message)"
        }

  # 失敗時のSlack通知
  - task: PowerShell@2
    displayName: 'Notify Slack (Failure)'
    condition: failed()
    inputs:
      targetType: 'inline'
      script: |
        $webhookUrl = 'https://hooks.slack.com/services/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'
        $payload = @{
          text = "❌ Terraform Apply に失敗しました。ログを確認してください。"
        } | ConvertTo-Json -Depth 3
        try {
          Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
        } catch {
          Write-Host "Slack通知に失敗しました（失敗通知）: $($_.Exception.Message)"
        }
