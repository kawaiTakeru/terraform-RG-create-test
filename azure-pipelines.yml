trigger:
- main

pool:
  name: Default
  demands:
    - agent.name -equals LAPTOP-OEOER8OI  # ã”è‡ªèº«ã®PCåã«åˆã‚ã›ã¦ã‚ã‚Šã¾ã™

jobs:
- job: Job
  displayName: 'Terraform RGä½œæˆï¼‹Slacké€šçŸ¥'
  steps:

  - checkout: self

  - task: PowerShell@2
    displayName: 'Step 1: Terraform Init'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "ğŸ“‹ Terraform Init é–‹å§‹"
        terraform init

  - task: PowerShell@2
    displayName: 'Step 2: Terraform Plan'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "ğŸ“‹ Terraform Plan é–‹å§‹"
        terraform plan

  - task: PowerShell@2
    displayName: 'Step 3: Terraform Apply'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "ğŸ“‹ Terraform Apply é–‹å§‹"
        terraform apply -auto-approve

  # âœ… æˆåŠŸæ™‚ã®Slacké€šçŸ¥
  - task: PowerShell@2
    displayName: 'Notify Slack (Success)'
    condition: succeeded()
    inputs:
      targetType: 'inline'
      script: |
        $webhookUrl = 'https://hooks.slack.com/services/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'
        $payload = @{
          text = "âœ… Terraform Apply å®Œäº†: `rg-terraform-test-01` ãŒä½œæˆã•ã‚Œã¾ã—ãŸ ğŸ‰"
        } | ConvertTo-Json -Depth 3
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'

  # âŒ å¤±æ•—æ™‚ã®Slacké€šçŸ¥
  - task: PowerShell@2
    displayName: 'Notify Slack (Failure)'
    condition: failed()
    inputs:
      targetType: 'inline'
      script: |
        $webhookUrl = 'https://hooks.slack.com/services/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'
        $payload = @{
          text = "âŒ Terraform Apply å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        } | ConvertTo-Json -Depth 3
        try {
          Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
        } catch {
          Write-Host "Slacké€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå¤±æ•—é€šçŸ¥ï¼‰: $($_.Exception.Message)"
        }
