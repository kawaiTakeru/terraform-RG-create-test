trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  tfWorkingDir: 'terraform'

steps:
# ----------------------------------------
# ğŸ§¹ Step 1: Terraform Init
# ----------------------------------------
- task: PowerShell@2
  displayName: 'Step 1: Terraform Init'
  inputs:
    targetType: 'inline'
    script: |
      cd $(tfWorkingDir)
      terraform init

# ----------------------------------------
# ğŸ§ª Step 2: Terraform Plan
# ----------------------------------------
- task: PowerShell@2
  displayName: 'Step 2: Terraform Plan'
  inputs:
    targetType: 'inline'
    script: |
      cd $(tfWorkingDir)
      terraform plan

# ----------------------------------------
# ğŸš€ Step 3: Terraform Applyï¼ˆæˆåŠŸæ™‚ã®ã¿ï¼‰
# ----------------------------------------
- task: PowerShell@2
  displayName: 'Step 3: Terraform Apply'
  condition: succeeded()
  inputs:
    targetType: 'inline'
    script: |
      cd $(tfWorkingDir)
      terraform apply -auto-approve

# ----------------------------------------
# âœ… Step 4: Slacké€šçŸ¥ï¼ˆæˆåŠŸæ™‚ï¼‰
# ----------------------------------------
- task: PowerShell@2
  displayName: 'Step 4: Notify Slack (Success)'
  condition: succeeded()
  inputs:
    targetType: 'inline'
    script: |
      [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $headers = @{
        "User-Agent" = "AzureDevOpsSlackBot/1.0"
      }
      $payload = @{
        text = "âœ… Terraform Apply å®Œäº†: ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ ğŸ‰"
      } | ConvertTo-Json -Compress
      try {
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json' -Headers $headers
        Write-Host "Slacké€šçŸ¥æˆåŠŸï¼ˆæˆåŠŸé€šçŸ¥ï¼‰"
      } catch {
        Write-Host "Slacké€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæˆåŠŸé€šçŸ¥ï¼‰: $_"
      }

# ----------------------------------------
# âŒ Step 5: Slacké€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰
# ----------------------------------------
- task: PowerShell@2
  displayName: 'Step 5: Notify Slack (Failure)'
  condition: failed()
  inputs:
    targetType: 'inline'
    script: |
      [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $headers = @{
        "User-Agent" = "AzureDevOpsSlackBot/1.0"
      }
      $payload = @{
        text = "âŒ Terraform Apply ã«å¤±æ•—ã—ã¾ã—ãŸ ğŸ’¥"
      } | ConvertTo-Json -Compress
      try {
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json' -Headers $headers
        Write-Host "Slacké€šçŸ¥æˆåŠŸï¼ˆå¤±æ•—é€šçŸ¥ï¼‰"
      } catch {
        Write-Host "Slacké€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå¤±æ•—é€šçŸ¥ï¼‰: $_"
      }
