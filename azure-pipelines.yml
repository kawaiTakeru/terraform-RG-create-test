trigger:
- main

pool:
  name: Default
  demands:
    - agent.name -equals LAPTOP-OEOER8OI

steps:
- checkout: self

- task: PowerShell@2
  displayName: 'Step 1: Terraform Init'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“¦ Terraform Init é–‹å§‹"
      terraform init

- task: PowerShell@2
  displayName: 'Step 2: Terraform Plan'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“ Terraform Plan é–‹å§‹"
      terraform plan

- task: PowerShell@2
  displayName: 'Step 3: Terraform Apply'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸš€ Terraform Apply é–‹å§‹"
      terraform apply -auto-approve

# âœ… Slack é€šçŸ¥ã‚¹ãƒ†ãƒƒãƒ—
- task: PowerShell@2
  displayName: 'Notify Slack'
  condition: succeeded()
  inputs:
    targetType: 'inline'
    script: |
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $payload = @{
        text = "âœ… Terraform Apply å®Œäº†: rg-terraform-test-01 ãŒä½œæˆã•ã‚Œã¾ã—ãŸ ğŸ‰"
      } | ConvertTo-Json -Compress
      Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
