trigger:
- none

variables:
  TF_VERSION: '1.6.6'

pool:
  name: Default  # Self-hosted Agent

steps:
# Terraform ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
- task: PowerShell@2
  displayName: 'Check Terraform Version'
  inputs:
    targetType: 'inline'
    script: |
      terraform -version
      Write-Host "â€» Terraform Version ãŒ ${env:TF_VERSION} ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª"

# Terraform Init
- task: PowerShell@2
  displayName: 'Step 1: Terraform Init'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“Œ Terraform Init é–‹å§‹"
      terraform init

# Terraform Plan
- task: PowerShell@2
  displayName: 'Step 2: Terraform Plan'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“‹ Terraform Plan é–‹å§‹"
      terraform plan -out=tfplan

# Terraform Apply
- task: PowerShell@2
  displayName: 'Step 3: Terraform Apply'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸš€ Terraform Apply é–‹å§‹"
      terraform apply -auto-approve tfplan

# Slacké€šçŸ¥ï¼ˆæˆåŠŸï¼‰
- task: PowerShell@2
  displayName: 'Notify Slack (Success)'
  condition: succeeded()
  inputs:
    targetType: 'inline'
    script: |
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $payload = @{ text = "âœ… Terraform Apply æˆåŠŸ (Version ${env:TF_VERSION}) ğŸ‰" } | ConvertTo-Json
      Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'

# Slacké€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
- task: PowerShell@2
  displayName: 'Notify Slack (Failure)'
  condition: failed()
  inputs:
    targetType: 'inline'
    script: |
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $payload = @{ text = "âŒ Terraform Apply å¤±æ•— (Version ${env:TF_VERSION}) âš ï¸" } | ConvertTo-Json
      try {
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
      } catch {
        Write-Host "Slacké€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: $($_.Exception.Message)"
      }
