trigger:
- none  # æ‰‹å‹•ã§å®Ÿè¡Œ

pool:
  name: Default
  demands:
    - agent.name -equals LAPTOP-OEOER8OI  # ã‚ãªãŸã®PCå

steps:
# Step 1: Terraform Init
- task: PowerShell@2
  displayName: 'Step 1: Terraform Init'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“‹ Terraform Init é–‹å§‹"
      terraform init

# Step 2: Terraform Plan
- task: PowerShell@2
  displayName: 'Step 2: Terraform Plan'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“‹ Terraform Plan é–‹å§‹"
      terraform plan

# Step 3: Terraform Apply
- task: PowerShell@2
  displayName: 'Step 3: Terraform Apply'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“‹ Terraform Apply é–‹å§‹"
      terraform apply -auto-approve

# Step 4: Slacké€šçŸ¥ï¼ˆæˆåŠŸæ™‚ï¼‰
- task: PowerShell@2
  displayName: 'Notify Slack (Success)'
  condition: succeeded()
  inputs:
    targetType: 'inline'
    script: |
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $payload = @{
        text = "âœ… Terraform Apply æˆåŠŸ: rg-terraform-test-01 ãŒä½œæˆã•ã‚Œã¾ã—ãŸ ğŸ‰"
      } | ConvertTo-Json
      Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'

# Step 5: Slacké€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰
- task: PowerShell@2
  displayName: 'Notify Slack (Failure)'
  condition: failed()
  inputs:
    targetType: 'inline'
    script: |
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $payload = @{
        text = "âŒ Terraform Apply ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
      } | ConvertTo-Json
      try {
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
      } catch {
        Write-Host "Slacké€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå¤±æ•—é€šçŸ¥ï¼‰: $($_.Exception.Message)"
      }
