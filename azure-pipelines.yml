trigger:
  - none

pool:
  name: Default  # Self-hosted Agent

steps:
# Terraform ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
- task: PowerShell@2
  displayName: 'Check Terraform Version'
  inputs:
    targetType: 'inline'
    script: |
      terraform -version
      Write-Host "â€» Terraform Version ã‚’æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„"

# Terraform Init
- task: PowerShell@2
  displayName: 'Step 1: Terraform Init'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“Œ Terraform Init é–‹å§‹"
      terraform init

# Terraform Plan
- task: PowerShell@2
  displayName: 'Step 2: Terraform Plan'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸ“‹ Terraform Plan é–‹å§‹"
      terraform plan -out=tfplan

# Terraform Applyï¼ˆé€”ä¸­ã¾ã§å¤±æ•—ã§ã‚‚å¾Œç¶šç¶šè¡Œã•ã›ã‚‹ï¼‰
- task: PowerShell@2
  displayName: 'Step 3: Terraform Apply'
  continueOnError: true
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "ğŸš€ Terraform Apply é–‹å§‹"
      terraform apply -auto-approve tfplan
      Write-Host "â†’ Terraform Apply çµ‚äº†ã‚³ãƒ¼ãƒ‰: $LASTEXITCODE"
      if ($LASTEXITCODE -ne 0) {
        Write-Error "ERROR: Terraform Apply failed with code $LASTEXITCODE"
        exit 1
      }

# Slacké€šçŸ¥ï¼ˆTerraformã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
- task: PowerShell@2
  displayName: 'Slacké€šçŸ¥ï¼ˆTerraformã‚¨ãƒ©ãƒ¼ï¼‰'
  condition: failed()
  inputs:
    targetType: 'inline'
    script: |
      $webhookUrl = 'https://hooks.slack.com/services/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'
      $buildId = $env:BUILD_BUILDID
      $pipelineName = $env:BUILD_DEFINITIONNAME
      $projectName = $env:SYSTEM_TEAMPROJECT
      $url = "https://dev.azure.com/$($env:SYSTEM_COLLECTIONURI.TrimEnd('/'))/$projectName/_build/results?buildId=$buildId&view=results"

      # ãƒ­ã‚°å‡ºåŠ›ï¼šURLã¨JSONå†…å®¹ã‚’ç¢ºèª
      Write-Host "DEBUG: Webhook URL = [$webhookUrl]"
      $logPayload = @{
        text = "âŒ Terraform Apply ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰`nãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³: $pipelineName`nãƒ“ãƒ«ãƒ‰ID: $buildId`nURL: $url"
        attachments = @(@{
          text = "$(Build.Repository.Name)ï¼šãƒ“ãƒ«ãƒ‰ãƒ­ã‚°å†…ã®ãƒ‡ãƒãƒƒã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        })
      }

      Write-Host "DEBUG: Payload JSON ="
      $logPayload | ConvertTo-Json -Depth 4 | Write-Host

      $payloadBytes = [System.Text.Encoding]::UTF8.GetBytes(($logPayload | ConvertTo-Json -Depth 4))
      $response = Invoke-RestMethod -Uri $webhookUrl -Method POST -Body $payloadBytes -ContentType 'application/json; charset=utf-8' -ErrorAction Stop

      Write-Host "DEBUG: Slack response = $response"
